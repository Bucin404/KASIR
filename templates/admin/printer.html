{% extends "base.html" %}

{% block title %}Manajemen Printer - Dapoer Teras Obor{% endblock %}

{% block body %}
<div class="flex min-h-screen">
    <!-- Sidebar -->
    {% set active_page = 'admin_printer' %}
    {% include 'partials/_sidebar.html' %}
    
    <main class="flex-1 ml-0 md:ml-64 p-4 md:p-8 pt-16 md:pt-8">
        <header class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-2xl font-display font-bold">üñ®Ô∏è Manajemen Printer</h1>
                <p class="text-gray-400">Kelola koneksi printer Bluetooth</p>
            </div>
            <a href="{{ url_for('printer_station') }}" target="_blank" 
                class="btn-primary px-4 py-2 rounded-xl font-medium flex items-center">
                <i class="fas fa-external-link-alt mr-2"></i>Printer Station
            </a>
        </header>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Status Card -->
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-wifi text-primary-400 mr-2"></i>
                    Status Koneksi
                </h2>
                
                <div id="printerStatus" class="flex items-center gap-4 p-4 rounded-xl bg-white/5 mb-4">
                    <div id="statusIndicator" class="w-5 h-5 rounded-full bg-gray-500"></div>
                    <div class="flex-1">
                        <p id="statusText" class="font-medium text-lg">Tidak Terhubung</p>
                        <p id="printerName" class="text-sm text-gray-400">-</p>
                    </div>
                </div>
                
                <div class="flex flex-wrap gap-3">
                    <button id="btnConnect" onclick="connectPrinterGlobal()" 
                        class="btn-primary px-4 py-2 rounded-xl font-medium flex items-center">
                        <i class="fas fa-bluetooth-b mr-2"></i>Hubungkan
                    </button>
                    
                    <button id="btnDisconnect" onclick="disconnectPrinterGlobal()" 
                        class="bg-red-500/20 text-red-400 hover:bg-red-500/30 px-4 py-2 rounded-xl font-medium transition hidden">
                        <i class="fas fa-unlink mr-2"></i>Putuskan
                    </button>
                    
                    <button id="btnTestPrint" onclick="testPrintGlobal()" 
                        class="bg-green-500/20 text-green-400 hover:bg-green-500/30 px-4 py-2 rounded-xl font-medium transition disabled:opacity-50"
                        disabled>
                        <i class="fas fa-print mr-2"></i>Test Print
                    </button>
                </div>
            </div>
            
            <!-- Info Card -->
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-info-circle text-primary-400 mr-2"></i>
                    Informasi Printer
                </h2>
                
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between p-3 rounded-lg bg-white/5">
                        <span class="text-gray-400">Nama Printer:</span>
                        <span id="infoName" class="font-medium">-</span>
                    </div>
                    <div class="flex justify-between p-3 rounded-lg bg-white/5">
                        <span class="text-gray-400">Device ID:</span>
                        <span id="infoId" class="font-medium text-xs">-</span>
                    </div>
                    <div class="flex justify-between p-3 rounded-lg bg-white/5">
                        <span class="text-gray-400">Auto-Reconnect:</span>
                        <span id="infoAutoConnect" class="font-medium">-</span>
                    </div>
                </div>
                
                <button onclick="forgetPrinterGlobal()" 
                    class="mt-4 w-full bg-white/5 hover:bg-white/10 text-gray-400 px-4 py-2 rounded-xl font-medium transition">
                    <i class="fas fa-trash mr-2"></i>Lupakan Printer
                </button>
            </div>
            
            <!-- Pending Queue Card -->
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-list-ol text-orange-400 mr-2"></i>
                    Antrian Cetak Pending
                </h2>
                
                <div class="flex items-center justify-between p-4 rounded-xl bg-white/5 mb-4">
                    <div>
                        <p class="text-gray-400 text-sm">Struk Menunggu</p>
                        <p id="pendingCount" class="text-3xl font-bold text-orange-400">0</p>
                    </div>
                    <div class="text-right">
                        <p class="text-gray-400 text-sm">Berhasil Cetak</p>
                        <p id="printedCount" class="text-3xl font-bold text-green-400">0</p>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button id="btnPrintPending" onclick="processPendingGlobal()" 
                        class="flex-1 bg-orange-500/20 text-orange-400 hover:bg-orange-500/30 px-4 py-2 rounded-xl font-medium transition disabled:opacity-50"
                        disabled>
                        <i class="fas fa-print mr-2"></i>Cetak Sekarang
                    </button>
                    <button onclick="clearPendingGlobal()" 
                        class="bg-white/5 hover:bg-white/10 text-gray-400 px-4 py-2 rounded-xl font-medium transition">
                        <i class="fas fa-trash mr-2"></i>Hapus
                    </button>
                </div>
            </div>
            
            <!-- Printer Station Card -->
            <div class="rounded-2xl p-6 bg-gradient-to-br from-primary-500/30 to-purple-500/30 border border-primary-500/20">
                <h2 class="text-lg font-semibold mb-2 flex items-center">
                    <i class="fas fa-desktop text-primary-400 mr-2"></i>
                    Printer Station
                </h2>
                <p class="text-gray-300 text-sm mb-4">
                    Buka Printer Station di tab terpisah untuk pencetakan yang lebih stabil. 
                    Koneksi printer akan tetap aktif meskipun berpindah halaman di tab lain.
                </p>
                <a href="{{ url_for('printer_station') }}" target="_blank" 
                    class="inline-flex items-center bg-white/10 hover:bg-white/20 px-4 py-2 rounded-xl font-medium transition">
                    <i class="fas fa-external-link-alt mr-2"></i>Buka Printer Station
                </a>
            </div>
        </div>
        
        <!-- Instructions -->
        <div class="mt-6 glass-card rounded-2xl p-6">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fas fa-book text-primary-400 mr-2"></i>
                Petunjuk Penggunaan
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-medium text-primary-400 mb-2">Cara Menghubungkan:</h3>
                    <ol class="list-decimal list-inside space-y-2 text-gray-300 text-sm">
                        <li>Nyalakan printer Bluetooth</li>
                        <li>Klik tombol "Hubungkan"</li>
                        <li>Pilih printer dari daftar yang muncul</li>
                        <li>Printer akan tersimpan untuk penggunaan selanjutnya</li>
                    </ol>
                </div>
                <div>
                    <h3 class="font-medium text-yellow-400 mb-2">‚ö†Ô∏è Catatan Penting:</h3>
                    <ul class="space-y-2 text-gray-300 text-sm">
                        <li>‚Ä¢ Koneksi Bluetooth terputus saat pindah halaman (batasan browser)</li>
                        <li>‚Ä¢ Gunakan <strong>Printer Station</strong> di tab terpisah untuk koneksi stabil</li>
                        <li>‚Ä¢ Struk yang gagal dicetak otomatis masuk antrian pending</li>
                        <li>‚Ä¢ Pesanan dari HP pembeli harus dicetak dari komputer kasir</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- PrinterManager is loaded from base.html -->

<script>
    // Use global PrinterManager from printer.js
    let printedCount = 0;
    
    // Update UI from PrinterManager state
    function updatePrinterUI() {
        const indicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const printerNameEl = document.getElementById('printerName');
        const btnConnect = document.getElementById('btnConnect');
        const btnDisconnect = document.getElementById('btnDisconnect');
        const btnTestPrint = document.getElementById('btnTestPrint');
        const btnPrintPending = document.getElementById('btnPrintPending');
        const infoName = document.getElementById('infoName');
        const infoId = document.getElementById('infoId');
        const infoAutoConnect = document.getElementById('infoAutoConnect');
        const pendingCountEl = document.getElementById('pendingCount');
        
        if (typeof PrinterManager === 'undefined') {
            statusText.textContent = 'PrinterManager tidak tersedia';
            return;
        }
        
        // Update connection status
        if (PrinterManager.isConnected && PrinterManager.device) {
            indicator.className = 'w-5 h-5 rounded-full bg-green-500 animate-pulse';
            statusText.textContent = 'Terhubung';
            statusText.className = 'font-medium text-lg text-green-400';
            printerNameEl.textContent = PrinterManager.device.name || 'Unknown';
            btnConnect.classList.add('hidden');
            btnDisconnect.classList.remove('hidden');
            btnTestPrint.disabled = false;
        } else {
            indicator.className = 'w-5 h-5 rounded-full bg-gray-500';
            statusText.textContent = 'Tidak Terhubung';
            statusText.className = 'font-medium text-lg text-gray-400';
            printerNameEl.textContent = PrinterManager.printerName || '-';
            btnConnect.classList.remove('hidden');
            btnDisconnect.classList.add('hidden');
            btnTestPrint.disabled = true;
        }
        
        // Update info
        infoName.textContent = PrinterManager.printerName || '-';
        infoId.textContent = PrinterManager.printerId || '-';
        infoAutoConnect.textContent = PrinterManager.autoReconnectSupported ? 'Didukung' : 'Tidak didukung';
        
        // Update pending count
        const pendingCount = PrinterManager.getPendingCount();
        pendingCountEl.textContent = pendingCount;
        btnPrintPending.disabled = pendingCount === 0 || !PrinterManager.isConnected;
        
        if (pendingCount > 0) {
            pendingCountEl.classList.add('animate-pulse');
        } else {
            pendingCountEl.classList.remove('animate-pulse');
        }
        
        // Update printed count
        document.getElementById('printedCount').textContent = printedCount;
    }
    
    // Connect using global PrinterManager
    async function connectPrinterGlobal() {
        if (typeof PrinterManager === 'undefined') {
            alert('PrinterManager tidak tersedia');
            return;
        }
        
        document.getElementById('statusText').textContent = 'Mencari printer...';
        document.getElementById('statusIndicator').className = 'w-5 h-5 rounded-full bg-yellow-500 animate-pulse';
        
        const success = await PrinterManager.connect();
        
        if (success) {
            showToast('Printer terhubung!', 'success');
        }
        
        updatePrinterUI();
    }
    
    // Disconnect using global PrinterManager
    async function disconnectPrinterGlobal() {
        if (typeof PrinterManager !== 'undefined') {
            await PrinterManager.disconnect();
            showToast('Printer diputuskan', 'info');
        }
        updatePrinterUI();
    }
    
    // Forget printer
    async function forgetPrinterGlobal() {
        if (confirm('Yakin ingin melupakan printer ini?')) {
            if (typeof PrinterManager !== 'undefined') {
                await PrinterManager.disconnect();
                PrinterManager.printerName = null;
                PrinterManager.printerId = null;
                
                // Clear from database
                fetch('/api/printer-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ printer_name: '', printer_id: '' })
                });
                
                showToast('Printer dilupakan', 'info');
            }
            updatePrinterUI();
        }
    }
    
    // Test print using global PrinterManager
    async function testPrintGlobal() {
        if (typeof PrinterManager === 'undefined' || !PrinterManager.isConnected) {
            alert('Printer tidak terhubung');
            return;
        }
        
        try {
            const encoder = new TextEncoder();
            let commands = [];
            
            commands.push(...PrinterManager.ESC_POS.INIT);
            commands.push(...PrinterManager.ESC_POS.ALIGN_CENTER);
            commands.push(...PrinterManager.ESC_POS.BOLD_ON);
            commands.push(...encoder.encode('================================\n'));
            commands.push(...encoder.encode('    TEST PRINT BERHASIL!\n'));
            commands.push(...encoder.encode('================================\n'));
            commands.push(...PrinterManager.ESC_POS.BOLD_OFF);
            commands.push(...encoder.encode('\n'));
            commands.push(...encoder.encode('Printer: ' + (PrinterManager.device?.name || 'Unknown') + '\n'));
            commands.push(...encoder.encode('Waktu: ' + new Date().toLocaleString('id-ID') + '\n'));
            commands.push(...encoder.encode('\n'));
            commands.push(...encoder.encode('================================\n'));
            commands.push(...encoder.encode('   Dapoer Teras Obor\n'));
            commands.push(...encoder.encode('================================\n'));
            commands.push(...PrinterManager.ESC_POS.FEED_LINES(4));
            commands.push(...PrinterManager.ESC_POS.CUT_PAPER);
            
            await PrinterManager.printRaw(commands);
            showToast('Test print berhasil!', 'success');
            printedCount++;
            updatePrinterUI();
        } catch (error) {
            console.error('Print error:', error);
            showToast('Gagal print: ' + error.message, 'error');
        }
    }
    
    // Process pending queue
    async function processPendingGlobal() {
        if (typeof PrinterManager !== 'undefined') {
            if (!PrinterManager.isConnected || !PrinterManager.characteristic) {
                showToast('Printer belum terhubung!', 'error');
                return;
            }
            showToast('Memproses antrian struk...', 'info');
            const beforeCount = PrinterManager.getPendingCount();
            await PrinterManager.processPendingQueue();
            const afterCount = PrinterManager.getPendingCount();
            printedCount += (beforeCount - afterCount);
            updatePrinterUI();
        }
    }
    
    // Clear pending queue
    function clearPendingGlobal() {
        if (confirm('Yakin ingin menghapus semua struk pending?')) {
            if (typeof PrinterManager !== 'undefined') {
                PrinterManager.pendingPrintQueue = [];
                PrinterManager.savePendingQueue();
                
                // Also clear from server
                fetch('/api/pending-prints/clear', { method: 'POST' });
                
                showToast('Antrian pending dihapus', 'info');
            }
            updatePrinterUI();
        }
    }
    
    // Toast notification
    function showToast(message, type = 'info') {
        const colors = {
            success: 'bg-green-500',
            warning: 'bg-yellow-500',
            error: 'bg-red-500',
            info: 'bg-blue-500'
        };
        
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg z-50 transition-opacity`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        // Wait for PrinterManager to be ready
        setTimeout(() => {
            updatePrinterUI();
            
            // Update UI periodically
            setInterval(updatePrinterUI, 2000);
        }, 500);
    });
</script>
{% endblock %}
