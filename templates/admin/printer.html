{% extends "base.html" %}

{% block title %}Manajemen Printer - Dapoer Teras Obor{% endblock %}

{% block body %}
<div class="flex min-h-screen bg-gray-100">
    {% include 'partials/_sidebar.html' %}
    
    <div class="flex-1 ml-0 md:ml-64 p-4 md:p-8 pt-16 md:pt-8">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">üñ®Ô∏è Manajemen Printer</h1>
            
            <!-- Status Card -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-lg font-semibold mb-4">Status Koneksi</h2>
                
                <div id="printerStatus" class="flex items-center gap-4 p-4 rounded-lg bg-gray-100">
                    <div id="statusIndicator" class="w-4 h-4 rounded-full bg-gray-400"></div>
                    <div>
                        <p id="statusText" class="font-medium">Tidak Terhubung</p>
                        <p id="printerName" class="text-sm text-gray-500">-</p>
                    </div>
                </div>
                
                <div id="autoConnectStatus" class="mt-4 text-sm text-gray-600">
                    <span id="autoConnectText">Auto-connect: Aktif</span>
                </div>
            </div>
            
            <!-- Actions Card -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-lg font-semibold mb-4">Aksi</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button id="btnConnect" onclick="connectPrinter()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition">
                        üîó Hubungkan Printer
                    </button>
                    
                    <button id="btnDisconnect" onclick="disconnectPrinter()" 
                        class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium transition hidden">
                        ‚ùå Putuskan Koneksi
                    </button>
                    
                    <button id="btnTestPrint" onclick="testPrint()" 
                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition disabled:opacity-50"
                        disabled>
                        üß™ Test Print
                    </button>
                    
                    <button id="btnForget" onclick="forgetPrinter()" 
                        class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium transition">
                        üóëÔ∏è Lupakan Printer
                    </button>
                </div>
            </div>
            
            <!-- Info Card -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-lg font-semibold mb-4">Informasi</h2>
                
                <div class="space-y-2 text-sm">
                    <p><strong>Printer Tersimpan:</strong> <span id="savedPrinter">-</span></p>
                    <p><strong>Device ID (MAC):</strong> <span id="savedPrinterId">-</span></p>
                    <p><strong>Terakhir Terhubung:</strong> <span id="lastConnected">-</span></p>
                    <p><strong>Auto-Reconnect:</strong> <span id="autoReconnectAttempts">0</span> percobaan</p>
                </div>
            </div>
            
            <!-- Pending Queue Card -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-lg font-semibold mb-4">üìã Antrian Print Pending</h2>
                
                <div class="space-y-2 text-sm">
                    <p><strong>Struk Menunggu:</strong> <span id="pendingCount" class="text-orange-600 font-bold">0</span> struk</p>
                    <p class="text-gray-500">Struk yang gagal dicetak akan otomatis dicetak saat printer terhubung kembali.</p>
                </div>
                
                <div class="mt-4 flex space-x-2">
                    <button id="btnPrintPending" onclick="processPendingQueue()" 
                        class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-medium transition disabled:opacity-50"
                        disabled>
                        üñ®Ô∏è Cetak Pending Sekarang
                    </button>
                    <button id="btnClearPending" onclick="clearPendingQueue()" 
                        class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition">
                        üóëÔ∏è Hapus Antrian
                    </button>
                </div>
            </div>
            
            <!-- Instructions Card -->
            <div class="bg-blue-50 rounded-lg p-6">
                <h2 class="text-lg font-semibold mb-4 text-blue-800">üìã Petunjuk Penggunaan</h2>
                
                <ol class="list-decimal list-inside space-y-2 text-blue-700">
                    <li>Pastikan printer Bluetooth thermal sudah menyala</li>
                    <li>Klik "Hubungkan Printer" dan pilih printer dari daftar</li>
                    <li>Setelah terhubung, printer akan tersimpan (nama + MAC address) untuk auto-connect</li>
                    <li>Gunakan "Test Print" untuk memastikan printer berfungsi</li>
                    <li>Printer akan otomatis reconnect saat berpindah halaman atau setelah terputus</li>
                    <li>Struk yang gagal dicetak akan masuk ke antrian pending dan otomatis dicetak saat printer terhubung</li>
                </ol>
                
                <div class="mt-4 p-3 bg-yellow-100 rounded text-yellow-800 text-sm">
                    <strong>‚ö†Ô∏è Catatan:</strong> Auto-connect memerlukan browser Chrome/Edge dan printer harus pernah dipair sebelumnya.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include Global Printer Manager -->
<script src="{{ url_for('static', filename='js/printer.js') }}"></script>

<script>
    // Printer state
    let bluetoothDevice = null;
    let printerCharacteristic = null;
    let isConnected = false;
    let autoConnectInterval = null;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 10;
    let savedPrinterId = null;
    let savedPrinterName = null;
    
    // Update UI based on connection state
    function updateUI() {
        const indicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const printerNameEl = document.getElementById('printerName');
        const btnConnect = document.getElementById('btnConnect');
        const btnDisconnect = document.getElementById('btnDisconnect');
        const btnTestPrint = document.getElementById('btnTestPrint');
        const attemptsEl = document.getElementById('autoReconnectAttempts');
        
        attemptsEl.textContent = reconnectAttempts;
        
        if (isConnected && bluetoothDevice) {
            indicator.className = 'w-4 h-4 rounded-full bg-green-500 animate-pulse';
            statusText.textContent = 'Terhubung';
            printerNameEl.textContent = bluetoothDevice.name || 'Unknown';
            btnConnect.classList.add('hidden');
            btnDisconnect.classList.remove('hidden');
            btnTestPrint.disabled = false;
            document.getElementById('lastConnected').textContent = new Date().toLocaleString('id-ID');
        } else {
            indicator.className = 'w-4 h-4 rounded-full bg-gray-400';
            statusText.textContent = 'Tidak Terhubung';
            printerNameEl.textContent = savedPrinterName || '-';
            btnConnect.classList.remove('hidden');
            btnDisconnect.classList.add('hidden');
            btnTestPrint.disabled = true;
        }
    }
    
    // Connect to printer
    async function connectPrinter() {
        try {
            document.getElementById('statusText').textContent = 'Mencari printer...';
            document.getElementById('statusIndicator').className = 'w-4 h-4 rounded-full bg-yellow-500 animate-pulse';
            
            bluetoothDevice = await navigator.bluetooth.requestDevice({
                filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }],
                optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
            });
            
            bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
            
            await connectToDevice();
            
            // Save printer name and ID to database
            savePrinterToDatabase(bluetoothDevice.name, bluetoothDevice.id);
            
        } catch (error) {
            console.error('Connection error:', error);
            alert('Gagal menghubungkan: ' + error.message);
            updateUI();
        }
    }
    
    // Connect to GATT server
    async function connectToDevice() {
        if (!bluetoothDevice) return;
        
        document.getElementById('statusText').textContent = 'Menghubungkan...';
        
        const server = await bluetoothDevice.gatt.connect();
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        printerCharacteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
        
        isConnected = true;
        reconnectAttempts = 0;
        updateUI();
        
        showToast('Printer terhubung!', 'success');
    }
    
    // Handle disconnection
    function onDisconnected() {
        isConnected = false;
        printerCharacteristic = null;
        updateUI();
        
        showToast('Printer terputus', 'warning');
        
        // Start auto-reconnect
        startAutoReconnect();
    }
    
    // Disconnect printer
    async function disconnectPrinter() {
        if (bluetoothDevice && bluetoothDevice.gatt.connected) {
            bluetoothDevice.gatt.disconnect();
        }
        isConnected = false;
        printerCharacteristic = null;
        stopAutoReconnect();
        updateUI();
    }
    
    // Forget printer
    async function forgetPrinter() {
        if (confirm('Yakin ingin melupakan printer ini?')) {
            await disconnectPrinter();
            bluetoothDevice = null;
            savedPrinterId = null;
            savedPrinterName = null;
            
            // Clear from database
            fetch('/api/printer-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ printer_name: '', printer_id: '' })
            });
            
            document.getElementById('savedPrinter').textContent = '-';
            showToast('Printer dilupakan', 'info');
        }
    }
    
    // Test print
    async function testPrint() {
        if (!printerCharacteristic) {
            alert('Printer tidak terhubung');
            return;
        }
        
        try {
            const encoder = new TextEncoder();
            const commands = [
                '\x1B\x40',           // Initialize
                '\x1B\x61\x01',       // Center align
                '================================\n',
                '    TEST PRINT BERHASIL!\n',
                '================================\n',
                '\n',
                'Printer: ' + (bluetoothDevice?.name || 'Unknown') + '\n',
                'Waktu: ' + new Date().toLocaleString('id-ID') + '\n',
                '\n',
                '================================\n',
                '   Dapoer Teras Obor\n',
                '================================\n',
                '\n\n\n',
                '\x1D\x56\x00'         // Cut paper
            ];
            
            const data = encoder.encode(commands.join(''));
            
            // Send in chunks
            const chunkSize = 100;
            for (let i = 0; i < data.length; i += chunkSize) {
                const chunk = data.slice(i, i + chunkSize);
                await printerCharacteristic.writeValue(chunk);
                await new Promise(r => setTimeout(r, 50));
            }
            
            showToast('Test print berhasil!', 'success');
        } catch (error) {
            console.error('Print error:', error);
            alert('Gagal print: ' + error.message);
        }
    }
    
    // Save printer to database
    async function savePrinterToDatabase(name, id) {
        try {
            await fetch('/api/printer-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ printer_name: name, printer_id: id })
            });
            savedPrinterName = name;
            savedPrinterId = id;
            document.getElementById('savedPrinter').textContent = name + ' (' + id + ')';
        } catch (error) {
            console.error('Save error:', error);
        }
    }
    
    // Load saved printer from database
    async function loadSavedPrinter() {
        try {
            const response = await fetch('/api/printer-status');
            const data = await response.json();
            if (data.printer_name) {
                savedPrinterName = data.printer_name;
                savedPrinterId = data.printer_id;
                document.getElementById('savedPrinter').textContent = data.printer_name + (data.printer_id ? ' (' + data.printer_id + ')' : '');
                return { name: data.printer_name, id: data.printer_id };
            }
        } catch (error) {
            console.error('Load error:', error);
        }
        return null;
    }
    
    // Auto-reconnect using getDevices API
    async function tryAutoConnect() {
        if (!navigator.bluetooth?.getDevices) {
            console.log('getDevices API not supported');
            return false;
        }
        
        try {
            const devices = await navigator.bluetooth.getDevices();
            console.log('Found paired devices:', devices.length);
            
            for (const device of devices) {
                console.log('Checking device:', device.name, device.id);
                // Match by ID (more reliable) or name
                if ((savedPrinterId && device.id === savedPrinterId) || 
                    (savedPrinterName && device.name === savedPrinterName)) {
                    console.log('Found matching device, attempting connection...');
                    bluetoothDevice = device;
                    bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
                    
                    // Try to connect
                    await connectToDevice();
                    return true;
                }
            }
        } catch (error) {
            console.log('Auto-connect attempt failed:', error.message);
        }
        return false;
    }
    
    // Auto-reconnect logic
    function startAutoReconnect() {
        if (autoConnectInterval) return;
        
        autoConnectInterval = setInterval(async () => {
            if (isConnected || reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                stopAutoReconnect();
                return;
            }
            
            reconnectAttempts++;
            document.getElementById('autoReconnectAttempts').textContent = reconnectAttempts;
            document.getElementById('autoConnectText').textContent = `Auto-connect: Mencoba (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})...`;
            
            const success = await tryAutoConnect();
            if (success) {
                stopAutoReconnect();
            }
        }, 5000);
    }
    
    function stopAutoReconnect() {
        if (autoConnectInterval) {
            clearInterval(autoConnectInterval);
            autoConnectInterval = null;
        }
        document.getElementById('autoConnectText').textContent = isConnected ? 'Auto-connect: Terhubung' : 'Auto-connect: Aktif';
    }
    
    // Pending queue functions
    function updatePendingUI() {
        const pendingCount = document.getElementById('pendingCount');
        const btnPrintPending = document.getElementById('btnPrintPending');
        
        if (typeof PrinterManager !== 'undefined') {
            const count = PrinterManager.getPendingCount();
            pendingCount.textContent = count;
            btnPrintPending.disabled = count === 0 || !PrinterManager.isConnected;
        }
    }
    
    async function processPendingQueue() {
        if (typeof PrinterManager !== 'undefined') {
            await PrinterManager.processPendingQueue();
            updatePendingUI();
        }
    }
    
    function clearPendingQueue() {
        if (confirm('Yakin ingin menghapus semua struk pending?')) {
            if (typeof PrinterManager !== 'undefined') {
                PrinterManager.pendingPrintQueue = [];
                PrinterManager.savePendingQueue();
                updatePendingUI();
                showToast('Antrian pending dihapus', 'info');
            }
        }
    }
    
    // Toast notification
    function showToast(message, type = 'info') {
        const colors = {
            success: 'bg-green-500',
            warning: 'bg-yellow-500',
            error: 'bg-red-500',
            info: 'bg-blue-500'
        };
        
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
        const saved = await loadSavedPrinter();
        
        // Display saved printer ID
        if (saved && saved.id) {
            document.getElementById('savedPrinterId').textContent = saved.id;
        }
        
        if (saved && (saved.name || saved.id)) {
            document.getElementById('statusText').textContent = 'Auto-connecting...';
            document.getElementById('statusIndicator').className = 'w-4 h-4 rounded-full bg-yellow-500 animate-pulse';
            
            const success = await tryAutoConnect();
            
            if (!success) {
                // Start background reconnect
                startAutoReconnect();
            }
        }
        
        updateUI();
        updatePendingUI();
        
        // Update pending UI periodically
        setInterval(updatePendingUI, 2000);
    });
</script>
{% endblock %}
